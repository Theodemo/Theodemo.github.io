name: List Repositories   # Nom du workflow GitHub Actions

on:
  push:
    branches:
      - main           # D√©clenchement lors d‚Äôun push sur la branche main
  workflow_dispatch:      # Permet de lancer le workflow manuellement depuis GitHub
  schedule:
    - cron: '0 0 * * *'  # Planification : ex√©cution automatique tous les jours √† minuit UTC

jobs:
  list_repositories:      # Nom du job
    runs-on: ubuntu-latest  # Le job s'ex√©cute sur une machine Ubuntu fournie par GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@v2  # R√©cup√®re le code source du d√©p√¥t courant

      - name: Store repositories in a variable
        id: list_repositories
        run: |
          echo "Fetching repository list..."
          
          # R√©cup√©ration de la liste des d√©p√¥ts publics et priv√©s d'un utilisateur GitHub via l'API

          REPOS_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            https://api.github.com/users/theodemo/repos?type=all)
          
          # V√©rifie si la requ√™te a renvoy√© une erreur
          if echo "$REPOS_JSON" | jq -e 'has("message")' > /dev/null; then
            echo "‚ùå Error fetching repos:"
            echo "$REPOS_JSON"
            exit 1
          fi

          # Transforme la liste en JSON simplifi√© contenant uniquement les infos utiles
          REPOS_LIST=$(echo "$REPOS_JSON" | jq -c '[.[] | {title: .name, description: (.description // "No description available"), url: .html_url, homepage: (.homepage // ""), full_name: .full_name, topics: (.topics // [])}]')

          # V√©rifie qu‚Äôil y a bien des d√©p√¥ts disponibles
          if [ -z "$REPOS_LIST" ] || [ "$REPOS_LIST" == "[]" ]; then
            echo "‚ùå No repositories found for user theodemo."
            exit 1
          fi

          # Stocke la liste des d√©p√¥ts dans une variable d‚Äôenvironnement utilisable dans les prochains steps
          echo "REPOS_LIST=$REPOS_LIST" >> $GITHUB_ENV

      - name: Create Markdown files
        run: |
          echo "Creating Markdown files for each repository..."
          mkdir -p _projects  # Dossier o√π seront stock√©s les fichiers g√©n√©r√©s

          # Parcours de chaque d√©p√¥t trouv√©
          echo "$REPOS_LIST" | jq -c '.[]' | while read -r repo; do
            title=$(echo "$repo" | jq -r '.title')
            full_name=$(echo "$repo" | jq -r '.full_name')

            # Ignore certains d√©p√¥ts sp√©cifiques (ex. le site lui-m√™me)
            if [[ "$title" == "theodemo" || "$title" == "en" || "$title" == "mon-site-jekyll" || "$title" == "theodemo.github.io" ]]; then
              echo "‚ö†Ô∏è Repository '$title' ignored."
              continue
            fi

            # R√©cup√©ration des infos du d√©p√¥t
            description=$(echo "$repo" | jq -r '.description')
            url=$(echo "$repo" | jq -r '.url')
            homepage=$(echo "$repo" | jq -r '.homepage')

            if [ -z "$title" ]; then
              echo "‚ö†Ô∏è Repository with no name detected, it will be ignored."
              continue
            fi

            # D√©termination de la cat√©gorie et sous-cat√©gorie en fonction des topics GitHub
            main_topic="Other"
            subcategory="General"

            for topic in $(echo "$repo" | jq -r '.topics[]'); do
              case "$topic" in
                # Cat√©gories Informatique
                "software-development") main_topic="Computer Science"; subcategory="Software Development" ;;
                "firmware-development") main_topic="Computer Science"; subcategory="Firmware Development" ;;
                "data-engineering") main_topic="Computer Science"; subcategory="Data Engineering" ;;
                "cybersecurity") main_topic="Computer Science"; subcategory="Cybersecurity" ;;
                "devops-automation") main_topic="Computer Science"; subcategory="DevOps & Automation" ;;
                "artificial-intelligence") main_topic="Computer Science"; subcategory="Artificial Intelligence" ;;
                "documentation") main_topic="Computer Science"; subcategory="Documentation" ;;

                # Cat√©gories √âlectronique
                "pcb-design") main_topic="Electronics"; subcategory="PCB Design" ;;
                "digital-system-design") main_topic="Electronics"; subcategory="Digital System Design" ;;
                "power-electronics") main_topic="Electronics"; subcategory="Power Electronics" ;;
                "signal-image-processing") main_topic="Electronics"; subcategory="Signal and Image Processing" ;;
                "pcb-reverse-engineering") main_topic="Electronics"; subcategory="PCB Reverse Engineering" ;;
                "pcb-repair") main_topic="Electronics"; subcategory="PCB Repair" ;;
                "digital-electronics") main_topic="Electronics"; subcategory="Digital Electronics" ;;

                # Cat√©gories M√©canique
                "mechanical-design") main_topic="Mechanical Engineering"; subcategory="Mechanical Design" ;;
                "analysis-simulation") main_topic="Mechanical Engineering"; subcategory="Analysis and Simulation" ;;
                "fluid-mechanics") main_topic="Mechanical Engineering"; subcategory="Fluid Mechanics" ;;
                "materials-mechanics-materials") main_topic="Mechanical Engineering"; subcategory="Materials and Mechanics of Materials" ;;
                "control-systems") main_topic="Mechanical Engineering"; subcategory="Control Systems" ;;
                "automation") main_topic="Mechanical Engineering"; subcategory="Automation" ;;
              esac
            done

            # V√©rifie si le repo contient un dossier d‚Äôimages
            echo "Cloning repository '$title' to check assets/img directory..."
            if ! git clone --depth=1 "https://github.com/$full_name.git" "$title"; then
              echo "‚ö†Ô∏è Failed to clone repository '$title'. Continuing with the next repository..."
              continue
            fi
            img_dir="$title/assets/img"

            if [ -d "$img_dir" ]; then
              echo "‚úÖ Found 'assets/img' directory in '$title'."
              img_files=$(find "$img_dir" -type f -iname '*.png')
              if [ -z "$img_files" ]; then
                echo "‚ö†Ô∏è No images found in 'assets/img' for repository '$title'."
                img_path="assets/img/projects/default.png"
              else
                target_dir="assets/img/projects/$title"
                mkdir -p "$target_dir"

                for img in $img_files; do
                  cp "$img" "$target_dir/"
                done

                img_path=$(echo "$img_files" | head -n 1)
              fi
            else
              echo "‚ö†Ô∏è 'assets/img' directory does not exist in repository '$title'."
              img_path="assets/img/projects/default.png"
            fi

            rm -rf "$title"  # Supprime le repo clon√© apr√®s v√©rification

            # Cr√©ation du fichier Markdown avec les m√©tadonn√©es du d√©p√¥t
            markdown_content="---\n"
            markdown_content+="layout: page\n"
            markdown_content+="title: $title\n"
            markdown_content+="description: $description\n"
            markdown_content+="full_name: $full_name\n"
            markdown_content+="img: assets/img/projects/$title/main.png\n"
            markdown_content+="importance: 1\n"
            markdown_content+="git: $url\n"
            markdown_content+="github: $url\n"
            markdown_content+="category: $main_topic\n"
            markdown_content+="subcategory: $subcategory\n"

            if [ -n "$homepage" ] && [ "$homepage" != "null" ]; then
              markdown_content+="web: $homepage\n"
            fi

            markdown_content+="---\n\n"

            # R√©cup√®re une partie du README (section Overview jusqu‚Äô√† License)
            README_CONTENT=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3.raw" \
                            https://api.github.com/repos/$full_name/readme)

            README_PART=$(echo "$README_CONTENT" | sed -n '/## üöÄ Overview/,/## üåü License/p' | sed '1d;$d')

            # Nettoyage et adaptation du README pour le site Jekyll
            README_PART=$(echo "$README_PART" | sed '/!\[Main Preview\](assets\/img\/main.png)/d')
            README_PART=$(echo "$README_PART" | sed -E "s|(## [^\n]+)|\1\n|g")
            README_PART=$(echo "$README_PART" | sed -E "s|(### [^\n]+)|\1\n|g")
            README_PART=$(echo "$README_PART" | sed -E "s|<img src=\"assets/img/([^\"]+).png\"[^>]*>|{% include image.html path=\"assets/img/projects/$title/\1.png\" width=\"100%\" %}|g")

            markdown_content+="$README_PART\n"
            
            # Sauvegarde du fichier Markdown
            echo -e "$markdown_content" > "_projects/$title.md"
            echo "‚úÖ Created _projects/$title.md"
          done

      - name: Commit and push changes
        run: |
          # Configure Git pour le commit
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Ajoute les nouveaux fichiers markdown et images
          git add _projects/*.md assets/img/projects/*
          git commit -m "Add Markdown files and images for repositories" || echo "No changes to commit"

          # Pousse les changements sur la branche main
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
